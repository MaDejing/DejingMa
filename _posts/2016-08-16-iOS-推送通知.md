---
layout: post
title: iOS 推送通知
---

<p class="subTitle">通知类型</p>
iOS中提供了2种推送通知
1. 本地推送通知(Local Notification)
2. 远程推送通知(Remote Notification)
<br />
<br />
<p class="subTitle">背景介绍</p>
<p class="listRowTitle">&middot; Push</p>
![]({{ site.baseurl}}/public/images/push/push01.png)
**Provider**: 为指定iOS设备应用程序提供Push的服务器。

**APNs**: Apple Push Notification Service(苹果消息推送服务器)。

**Devices**: iOS设备，用来接收APNs下发下来的消息。

**Client App**: iOS设备上的应用程序，用来接收APNs下发的消息到指定的一个客户端App(消息的最终响应者)。

<p class="listRowTitle">&middot; 获取DeviceToken流程</p>
![]({{ site.baseurl}}/public/images/push/push02.png)
<ol>
    <li>向APNs（Apple Push Notification Services）发送设备的<font class="specialText">UDID</font>和<font class="specialText">Bundle Identifier</font>，创建Push SSL Certification(推送证书);</li>
    <li>经APNs加密生成一个<font class="specialText">DeviceToken</font>（官方解释DeviceToken：an opaque identifier assigned to a specific app on a specific device）;</li>
    <li>客户端获取<font class="specialText">DeviceToken</font>;</li>
    <li>将DeviceToken发送给Provider（理解为服务器）。</li>
</ol>

<p class="listRowTitle">&middot; 消息推送流程</p>
![]({{ site.baseurl}}/public/images/push/push03.png)

<p class="subTitle">证书配置</p>
<ol>
    <li style="margin-bottom: 20px;">用付费帐号登录到[苹果开发者中心](https://developer.apple.com/membercenter/index.action)。</li>
    <li>根据需求选择<i><u>Apple Push Notification service SSL <font class="specialText">(Sandbox)</font></u></i> 或者 <i><u>Apple Push Notification service SSL <font class="specialText">(Sandbox & Production)</font></u></i>类型的证书。
        <p class="indentText">- 一个用Development Provisioning Profile签名的App生成的 Device Token只能和Sandbox APNS Server结合使用(<u>开发环境测试</u>用)。</p>
        <p class="indentText">- 一个用AdHoc Provisioning Profile或者AppStore Provisioning Profile签名的App生成的Device Token只能和Production APNS Server结合使用(<u>生产环境App Store发布</u>使用)。</p>
    </li>
    <li>创建一个App ID
        <p class="indentText">- 创建过程中Description可以任意填写;</p>
        <p class="indentText">- Bundle Identifier一般用com.company.AppName这样的格式，例如com.mycompany.demo。</p>
        <blockquote style="margin-bottom: 20px;">
            <b>Note</b>: 要用push功能的Bundle Identifier一定不能出现通配符，比如com.mycompany.*，这样的名字是不能使用push的。
        </blockquote>
    </li>
    <li>生成Push SSL Certificate
        <p class="indentText">- 生成好App ID后点击Configure进入配置页;</p>
        <p class="indentText">- 打开Enable for Apple Push Notification service选项，该选项下有Development Push SSL Certificate和Production Push SSL Certificate两个SSL Certificate可以配置;</p>
        <p class="indentText">- 一个用Development Provisioning Profile签名的App生成的 Device Token只能和Sandbox APNS Server结合使用(<u>开发环境测试</u>用);</p>
        <p class="indentText">- 一个用AdHoc  Provisioning Profile或者AppStore  Provisioning Profile签名的App生成的Device Token只能和Production APNS Server结合使用(<u>生产环境App Store发布</u>使用);</p>
        <p class="indentText">- 选择CSR文件，这就是生成开发证书时的<i><u>CertificateSigningRequest.certSigningRequest</u></i>文件，选择好CSR后就生成好相应的SSL Certificate了;</p>
        <p class="indentText">- 下载下来，保存名为aps_developer.cer。</p>
    </li>
    <li style="margin-bottom: 20px;">从Keychain中导出私钥、设置好密码，命名为<i><u>private_key.p12</u></i></li>
    <li>生成push证书
        <p class="indentText" style="margin-bottom: 0px;"><b>这时我们一共得到3个文件：</b></p>
        <p class="indentText" style="margin-bottom: 0px;">CertificateSigningRequest.certSigningRequest</p>
        <p class="indentText" style="margin-bottom: 0px;">private_key.p12</p>
        <p class="indentText">aps_developer.cer</p>
        <blockquote>
            <p class="specialText" style="margin-bottom: 0px;">将aps_developer.cer转成pem格式</p>
            <p>openssl x509 -in aps_developer.cer -inform DER -out aps_developer.pem -outform PEM</p>
            <p class="specialText" style="margin-bottom: 0px;">将private_key.p12格式的私钥转换成private_key.pem</p>
            <p style="margin-bottom: 0px;">openssl pkcs12 -nocerts -out private_key.pem -in private_key.p12</p>
            <p>这一步会要求输入p12私钥的密码，以及设置新生成的pem的密码。</p>
            <p class="specialText" style="margin-bottom: 0px;">创建用于服务端的SSL p12格式证书，命名为aps_developer.p12</p>
            <p>openssl pkcs12 -export -in aps_developer.pem -inkey private_key.pem -certfile CertificateSigningRequest.certSigningRequest -name "aps_developer" -out aps_developer.p12</p>
        </blockquote>
        <p style="margin-bottom: 20px;">这一步会要求输入<i><u><b>private_key.pem</b></u></i>的密码，注意<i><u>不是private_key.p12</u></i>的密码。如果密码错误，或者CertificateSigningRequest.certSigningRequest文件不匹配都不能正常生成aps_developer.p12文件，如果生成的aps_developer.p12文件大小是0，说明生成过程中出了问题，请检查pem私钥、密码、以及CertificateSigningRequest.certSigningRequest是否正确。</p>
    </li>
    <li style="margin-bottom: 20px;">
        <i><u><b>aps_developer.p12</b></u></i>就是Provider向APNS发送push消息需要的<i><u>SSL证书</u></i>。把这个<i><u>证书和密码</u></i>提供给服务端，服务端就可以发送push消息给APNS了。这时服务端已经可以工作了，但客户端还必须配置相应的Provisioning Profile才能启动应用的push功能。
    </li>
    <li style="margin-bottom: 20px;">
        服务器配置需注意的是，当我们生成的是<i><u>开发环境</u></i>的push证书，所以服务器应该连接APNS的sandbox环境地址：<i><u>gateway.sandbox.push.apple.com:2195</u></i>，如果<i><u>应用正式发布</u><i>，就要连接正式环境，必须生成相应的发布证书，并连接APNS正式环境地址：<i><u>gateway.push.apple.com:2195</u></i>。
    </li>
    <li>生成Provisioning Profile
        <blockquote>
            <p style="margin-bottom: 0px;">新建Profile，命名为push_dev</p>
            <p style="margin-bottom: 0px;">选择相应证书</p>
            <p style="margin-bottom: 0px;">选择App ID</p>
            <p style="margin-bottom: 0px;">选择设备</p>
            <p style="margin-bottom: 0px;">下载并安装该Profile供开发使用</p>
            <p style="margin-bottom: 0px;">用Xcode打开客户端工程，设置Info.plist的Bundle identifier为com.mycompany.demo</p>
            <p style="margin-bottom: 0px;">打开工程设置，必须将证书设置为与push_dev关联的证书</p>
        </blockquote>
    </li>
</ol>


